<!DOCTYPE html>
<html>
<head>
    <title>‚ú® | HRM for –ó–ê–û –ù–ò–ü–û | üñ§</title>
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <link rel='stylesheet' href='/bootstrap/css/bootstrap.css' />
    <script src="/bootstrap/js/bootstrap.js"></script>
</head>
<body>
<%- include('header', {login: login, links: links}); %>
<div class="row">
    <div class="col-12">
        <div>
            <h1>–£—á–µ—Ç –¢–ë</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/admin">–ì–ª–∞–≤–Ω–∞—è</a></li>
                    <li class="breadcrumb-item active" aria-current="page">–£—á–µ—Ç –¢–ë</li>
                </ol>
            </nav>
            <button type="button" class="btn btn-primary mb-2" data-bs-toggle="modal"
                    data-bs-target="#addCategoryModal" <%= (access & 4) ? '' : 'disabled' %>>
                –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é
            </button>
            <button type="button" class="btn btn-primary mb-2" data-bs-toggle="modal"
                    data-bs-target="#deleteCategoryModal" <%= (access & 4) ? '' : 'disabled' %>>
                –£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é
            </button>
            <button type="button" class="btn btn-primary mb-2" data-bs-toggle="modal"
                    data-bs-target="#uploadXlsModal" <%= (access & 4) ? '' : 'disabled' %>>
                –ò–º–ø–æ—Ä—Ç –∏–∑ excel
            </button>
            <button type="button" class="btn btn-primary mb-2" data-bs-toggle="modal"
                    data-bs-target="#downloadXlsModal" <%= (access & 8) ? '' : 'disabled' %>>
                –≠–∫—Å–ø–æ—Ä—Ç –≤ excel
            </button>
            <button type="button" class="btn btn-primary mb-2" id="checkTb" <%= (access & 8) ? '' : 'disabled' %>>
                –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ä–æ–∫–∏
            </button>
            <div class="d-inline-block">
                <form action="tb/search" method="get">
                    <input type="search" placeholder="–ü–æ–∏—Å–∫" name="s" maxlength="100">
                    <button type="submit" class="btn btn-primary">–ü–æ–∏—Å–∫</button>
                </form>
            </div>
        </div>
        <div class="table-wrapper">
            <table>
                <thead>
                <tr>
                    <th></th>
                    <th></th>
                    <th></th>
                    <% categories.forEach((category) => { %>
                    <td colspan="4"><%= category.name %></td>
                    <% }); %>
                    <td></td>
                </tr>
                <tr>
                    <th>–§–ò–û</th>
                    <th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>
                    <th>–û—Ç–¥–µ–ª</th>
                    <% categories.forEach(() => { %>
                        <td>–í—ã–¥–∞–Ω</td>
                        <td>–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ</td>
                        <td>–ì—Ä—É–ø–ø–∞</td>
                        <td>–°–∫–∞–Ω</td>
                    <% }); %>
                    <td></td>
                </tr>
                </thead>
                <tbody>
                    <% let pos = 0; for (let i = 0; i < table.length; i++) { /* —Å–±–æ—Ä–∫–∞ —Å–ª–æ–∂–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã... */
                        if (table[i].skip) { /* –µ—Å–ª–∏ –ø—Ä–æ—à–ª–∞—è —Å—Ç—Ä–æ–∫–∞ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è, —Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ü–∏–∫–ª —Å j-—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–¥–æ–ø–∏—Å—ã–≤–∞–µ—Ç —Å—Ç—Ä–æ–∫—É) */
                            for (let j = pos; j < categories.length; j++) {
                                if (categories[j].ID === table[i].category_id) /* –≤—ã–≤–æ–¥–∏–º –∑–Ω–∞—á–µ–Ω–∏—è –∫–∞—Ç–µ—Ä–∏–∏ –∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–∏–∫–ª
                                data-find= –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è –ø–æ–∏—Å–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π */ {%>
                                    <td data-find="<%= table[i].employee_id + "-" + table[i].category_id%>" data-name="issued" data-value="<%= table[i].issued %>"
                                        data-id="<%= table[i]?.ID %>">
                                        <%= table[i].issued?.toLocaleDateString("ru") %></td>
                                    <td data-find="<%= table[i].employee_id + "-" + table[i].category_id%>" data-name="validUntil" data-value="<%= table[i].validUntil %>">
                                        <%= table[i].validUntil?.toLocaleDateString("ru") %></td>
                                    <td data-find="<%= table[i].employee_id + "-" + table[i].category_id%>" data-name="group_name">
                                        <%= table[i].group_name %></td>
                                    <td data-find="<%= table[i].employee_id + "-" + table[i].category_id%>" data-name="scan">
                                        <a href="<%= table[i].scan_href %>"><%= table[i].scan_name %></a></td>
                                <% pos = j + 1;break;} else {  /* –¥–æ–±–∞–≤–ª—è–µ–º –ø—É—Å–ª—Ç—ã–µ td */ %>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                <% }
                            }
                            if (table[i].employee_id === table[i+1]?.employee_id) { /* –µ—Å–ª–∏ –≤ —Å–ª–µ–¥. —Å—Ç—Ä–æ–∫–µ —ç—Ç–æ—Ç –∂–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ */
                                table[i+1].skip = true;
                            } else { /* –∏–Ω–∞—á–µ –≤—ã–≤–æ–¥–∏–º –¥–æ –∫–æ–Ω—Ü–∞ —Å—Ç—Ä–æ–∫–∏ –ø—É—Å—Ç—ã–µ td (–∑–∞–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É) */
                                for (let j = pos; j < categories.length; j++) {%>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                <%} pos = 0; /* –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É */%>
                                    <td>
                                        <button type="button" data-bs-toggle="modal" data-bs-target="#tbAddInRowModal" class="btn"
                                                <%= (access & 4) ? '' : 'disabled' %>
                                                data-fio="<%= table[i]?.fio %>"
                                                data-employeeId="<%= table[i]?.employee_id %>"
                                        >
                                            –î–æ–±–∞–≤–∏—Ç—å/–∏–∑–º–µ–Ω–∏—Ç—å
                                        </button>
                                        <button type="button" data-bs-toggle="modal" data-bs-target="#tbDeleteFromRowModal" class="btn"
                                                <%= (access & 4) ? '' : 'disabled' %>
                                                data-id="<%= table[i]?.ID %>"
                                                data-fio="<%= table[i]?.fio %>"
                                                data-employeeId="<%= table[i]?.employee_id %>"
                                        >
                                            –£–¥–∞–ª–∏—Ç—å
                                        </button>
                                    </td>
                                </tr>
                            <%}
                        } else { /* –µ—Å–ª–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ */ pos = 0;
                            if (table[i].employee_id === table[i+1]?.employee_id) {
                                table[i+1].skip = true;
                            %>
                            <tr>
                                <th><%= table[i].fio %></th>
                                <th><%= table[i].position %></th>
                                <th><%= table[i].subdivision %></th>
                                <% for (let j = 0; j < categories.length; j++) {
                                    if (categories[j].ID === table[i].category_id) {%>
                                        <td data-find="<%= table[i].employee_id + "-" + table[i].category_id%>" data-name="issued" data-value="<%= table[i].issued %>"
                                            data-id="<%= table[i]?.ID %>">
                                                <%= table[i].issued?.toLocaleDateString("ru") %></td>
                                        <td data-find="<%= table[i].employee_id + "-" + table[i].category_id%>" data-name="validUntil" data-value="<%= table[i].validUntil %>">
                                                <%= table[i].validUntil?.toLocaleDateString("ru") %></td>
                                        <td data-find="<%= table[i].employee_id + "-" + table[i].category_id%>" data-name="group_name">
                                            <%= table[i].group_name %></td>
                                        <td data-find="<%= table[i].employee_id + "-" + table[i].category_id%>" data-name="scan">
                                            <a href="<%= table[i].scan_href %>"><%= table[i].scan_name %></a></td>
                                    <% pos = j + 1; break;} else { %>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                    <% }
                                }
                            } else { /* –µ—Å–ª–∏ —É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –æ–¥–Ω–∞ –∑–∞–ø–∏—Ç—å –ø–æ –¢–ë; */ %>
                            <tr>
                                <th><%= table[i].fio %></th>
                                <th><%= table[i].position %></th>
                                <th><%= table[i].subdivision %></th>
                                <% categories.forEach((category) => {
                                    if (category.ID === table[i].category_id) { %>
                                        <td data-find="<%= table[i].employee_id + "-" + table[i].category_id%>" data-name="issued" data-value="<%= table[i].issued %>"
                                            data-id="<%= table[i]?.ID %>">
                                                <%= table[i].issued?.toLocaleDateString("ru") %></td>
                                        <td data-find="<%= table[i].employee_id + "-" + table[i].category_id%>" data-name="validUntil" data-value="<%= table[i].validUntil %>">
                                                <%= table[i].validUntil?.toLocaleDateString("ru") %></td>
                                        <td data-find="<%= table[i].employee_id + "-" + table[i].category_id%>" data-name="group_name">
                                            <%= table[i].group_name %></td>
                                        <td data-find="<%= table[i].employee_id + "-" + table[i].category_id%>" data-name="scan">
                                            <a href="<%= table[i].scan_href %>"><%= table[i].scan_name %></a></td>
                                    <% } else { %>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                    <% }
                                }) %>
                            <td>
                                <button type="button" data-bs-toggle="modal" data-bs-target="#tbAddInRowModal" class="btn"
                                        <%= (access & 4) ? '' : 'disabled' %>
                                        data-fio="<%= table[i]?.fio %>"
                                        data-employeeId="<%= table[i]?.employee_id %>"
                                >
                                    –î–æ–±–∞–≤–∏—Ç—å/–∏–∑–º–µ–Ω–∏—Ç—å
                                </button>
                                <button type="button" data-bs-toggle="modal" data-bs-target="#tbDeleteFromRowModal" class="btn"
                                        <%= (access & 4) ? '' : 'disabled' %>
                                        data-fio="<%= table[i]?.fio %>"
                                        data-employeeId="<%= table[i]?.employee_id %>"
                                >
                                    –£–¥–∞–ª–∏—Ç—å
                                </button>
                            </td>
                            </tr>
                            <% }
                        }
                    } %>
                </tbody>
            </table>
        </div>
    </div>
</div>
<!-- Modal add category -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="tb/add-category" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCategoryModalLabel">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="categoryName" class="col-form-label">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                        <input type="text" class="form-control"
                               id="categoryName" name="categoryName" minlength="3" maxlength="100" required>
                    </div>
                    <div class="mb-3">
                        <label for="categoryValidYears" class="col-form-label">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è:</label>
                        <input type="number" class="form-control" id="categoryValidYears" name="categoryValidYears" min="0" max="100">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                    <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Modal delete category -->
<div class="modal fade" id="deleteCategoryModal" tabindex="-1" aria-labelledby="deleteCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="tb/delete-category" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteCategoryModalLabel">–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="categoryName_delete" class="col-form-label">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:</label>
                        <select class="form-select" id="categoryName_delete" name="categoryName_delete" required>
                            <% categories.forEach((category) => { %>
                                <option value="<%= category.name %>"><%= category.name %></option>
                            <% }); %>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                    <button type="submit" class="btn btn-primary">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Modal add tb row -->
<div class="modal fade" id="tbAddInRowModal" tabindex="-1" aria-labelledby="tbAddInRowModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="tb/add-in-row" method="post">
                <input type="hidden" name="tbId_add" id="tbId_add">
                <input type="hidden" name="employeeId_add" id="employeeId_add">
                <div class="modal-header">
                    <h5 class="modal-title" id="tbAddInRowModalLabel">–î–æ–±–∞–≤–∏—Ç—å —Å–≤–µ–¥–µ–Ω–∏—è –æ –ø—Ä–æ–≤–µ—Ä–∫–∞—Ö –∑–Ω–∞–Ω–∏–π —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –û–¢</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <p class="col-form-label">–§–∏–æ: <span id="tbAddInRow-fio"></span></p>
                    </div>
                    <div class="mb-3">
                        <label for="tbCategory_add" class="col-form-label">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:</label>
                        <select class="form-select" id="tbCategory_add" name="tbCategory_add" required>
                            <option>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                            <% categories.forEach((category) => { %>
                                <option value="<%= category.name %>" data-category-id="<%= category.ID %>" data-validYears="<%= category.validYears %>"><%= category.name %></option>
                            <% }); %>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="tbDateOfIssue_add" class="col-form-label">–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏:</label>
                        <input type="date" class="form-control" id="tbDateOfIssue_add" name="tbDateOfIssue_add">
                    </div>
                    <div class="mb-3">
                        <label for="tbValidUntil_add" class="col-form-label">–î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –¥–æ:</label>
                        <input type="date" class="form-control" id="tbValidUntil_add" name="tbValidUntil_add" required>
                    </div>
                    <div class="mb-3">
                        <label for="tbGroup_add" class="col-form-label">–ì—Ä—É–ø–ø–∞:</label>
                        <input type="text" class="form-control" id="tbGroup_add" name="tbGroup_add" maxlength="100">
                    </div>
                    <div class="mb-3">
                        <label for="tbScanName_add" class="col-form-label">–°–∫–∞–Ω (–æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è):</label>
                        <input type="text" class="form-control" id="tbScanName_add" name="tbScanName_add" maxlength="100">
                    </div>
                    <div class="mb-3">
                        <label for="tbScanHref_add" class="col-form-label">–°–∫–∞–Ω (—Å—Å—ã–ª–∫–∞):</label>
                        <input type="text" class="form-control" id="tbScanHref_add" name="tbScanHref_add" maxlength="100">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                    <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Modal delete tb row -->
<div class="modal fade" id="tbDeleteFromRowModal" tabindex="-1" aria-labelledby="tbDeleteFromRowModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="tb/delete-from-row" method="post">
                <input type="hidden" name="tbEmployeeId_delete" id="tbEmployeeId_delete">
                <input type="hidden" name="tbCategoryId_delete" id="tbCategoryId_delete">
                <div class="modal-header">
                    <h5 class="modal-title" id="tbDeleteFromRowModalLabel">–£–¥–∞–ª–∏—Ç—å —Å–≤–µ–¥–µ–Ω–∏—è –æ –ø—Ä–æ–≤–µ—Ä–∫–µ –∑–Ω–∞–Ω–∏–π —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –û–¢</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <p class="col-form-label">–§–∏–æ: <span id="tbDeleteFromRow-fio"></span></p>
                    </div>
                    <div class="mb-3">
                        <label for="tbCategorySelect_delete" class="col-form-label">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:</label>
                        <select class="form-select" id="tbCategorySelect_delete" name="tbCategorySelect_delete" required>
                            <option>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                            <% categories.forEach((category) => { %>
                                <option value="<%= category.ID %>" data-category-id="<%= category.ID %>" disabled>
                                    <%= category.name %>
                                </option>
                            <% }); %>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                    <button type="submit" class="btn btn-primary">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Modal upload xls -->
<div class="modal fade" id="uploadXlsModal" tabindex="-1" aria-labelledby="uploadXlsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="tb/upload-xls" method="post" id="uploadXlsForm" enctype="multipart/form-data" accept-charset="UTF-8">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadXlsModalLabel">–ò–º–ø–æ—Ä—Ç –∏–∑ excel</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="uploadXls" class="form-label">–í—ã–±–µ—Ä–µ—Ç–µ —Ñ–∞–π–ª</label>
                        <input class="form-control" type="file" name="file" id="uploadXls" accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                    <button type="submit" class="btn btn-primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Modal download xls -->
<div class="modal fade" id="downloadXlsModal" tabindex="-1" aria-labelledby="downloadXlsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="" method="post" id="downloadXlsForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="downloadXlsModalLabel">–≠–∫—Å–ø–æ—Ä—Ç –≤ excel</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                    <a href="tb/download-xls">–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª –∏ —Å–∫–∞—á–∞—Ç—å</a>
                </div>
            </form>
        </div>
    </div>
</div>
<%- include('toast') %>
<script src="/javascripts/tb.js"></script>
</body>
</html>
